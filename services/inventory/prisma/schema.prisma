// Inventory/Shipping Service Prisma Schema
// Connects to the shared database during Phase 1-3
// Will be split to its own database in Phase 4

generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/inventory-client"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["inventory_service"]
}

// ──────────────────────────────────────────────
// Warehouse & Inventory
// ──────────────────────────────────────────────

model Warehouse {
  id              String   @id @default(uuid())
  name            String
  code            String   @unique
  address         String?
  city            String?
  state           String?
  country         String   @default("GB")
  postalCode      String?
  latitude        Float?
  longitude       Float?
  contactEmail    String?
  contactPhone    String?
  managerName     String?
  capacity        Int?
  warehouseType   String   @default("STANDARD")
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  inventory     InventoryLocation[]
  transfersFrom StockTransfer[]     @relation("TransfersFrom")
  transfersTo   StockTransfer[]     @relation("TransfersTo")

  @@map("warehouses")
  @@schema("inventory_service")
}

model InventoryLocation {
  id                String   @id @default(uuid())
  warehouseId       String
  productId         String
  quantity          Int      @default(0)
  reserved          Int      @default(0)
  lowStockThreshold Int      @default(10)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  warehouse         Warehouse          @relation(fields: [warehouseId], references: [id])
  stockReservations StockReservation[]
  stockMovements    StockMovement[]

  @@unique([warehouseId, productId])
  @@map("inventory_locations")
  @@schema("inventory_service")
}

model StockReservation {
  id                  String   @id @default(uuid())
  inventoryLocationId String
  orderId             String?
  cartId              String?
  quantity            Int
  status              String   @default("ACTIVE")
  expiresAt           DateTime
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  inventoryLocation InventoryLocation @relation(fields: [inventoryLocationId], references: [id])

  @@map("stock_reservations")
  @@schema("inventory_service")
}

model StockTransfer {
  id              String    @id @default(uuid())
  fromWarehouseId String
  toWarehouseId   String
  productId       String
  quantity        Int
  status          String    @default("PENDING")
  requestedBy     String?
  completedBy     String?
  completedAt     DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  fromWarehouse Warehouse @relation("TransfersFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse @relation("TransfersTo", fields: [toWarehouseId], references: [id])

  @@map("stock_transfers")
  @@schema("inventory_service")
}

model StockMovement {
  id                  String   @id @default(uuid())
  inventoryLocationId String
  productId           String
  quantity            Int
  movementType        String
  referenceType       String?
  referenceId         String?
  performedBy         String?
  notes               String?
  createdAt           DateTime @default(now())

  inventoryLocation InventoryLocation @relation(fields: [inventoryLocationId], references: [id])

  @@map("stock_movements")
  @@schema("inventory_service")
}

// ──────────────────────────────────────────────
// Shipping
// ──────────────────────────────────────────────

model ShippingMethod {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String   @default("FLAT_RATE")
  isActive    Boolean  @default(true)
  sellerId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rules ShippingRule[]

  @@map("shipping_methods")
  @@schema("inventory_service")
}

model ShippingRule {
  id                    String   @id @default(uuid())
  shippingMethodId      String
  name                  String
  priority              Int      @default(0)
  conditions            Json     @default("{}")
  rate                  Decimal  @db.Decimal(12, 2)
  freeShippingThreshold Decimal? @db.Decimal(12, 2)
  estimatedDays         Int?
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  shippingMethod ShippingMethod @relation(fields: [shippingMethodId], references: [id])

  @@map("shipping_rules")
  @@schema("inventory_service")
}

// ──────────────────────────────────────────────
// Fulfillment & Logistics
// ──────────────────────────────────────────────

model FulfillmentCenter {
  id           String   @id @default(uuid())
  name         String
  address      String
  city         String
  country      String   @default("GB")
  postalCode   String?
  latitude     Float?
  longitude    Float?
  contactEmail String?
  contactPhone String?
  capacity     Int?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  shipments Shipment[]

  @@map("fulfillment_centers")
  @@schema("inventory_service")
}

model Shipment {
  id                  String    @id @default(uuid())
  submissionId        String?   @unique
  fulfillmentCenterId String?
  logisticsPartnerId  String?
  trackingNumber      String?
  status              String    @default("PENDING")
  verifiedBy          String?
  verificationNotes   String?
  receivedAt          DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  fulfillmentCenter FulfillmentCenter? @relation(fields: [fulfillmentCenterId], references: [id])
  logisticsPartner  LogisticsPartner?  @relation(fields: [logisticsPartnerId], references: [id])

  @@map("shipments")
  @@schema("inventory_service")
}

model LogisticsPartner {
  id           String   @id @default(uuid())
  name         String
  code         String   @unique
  type         String   @default("CARRIER")
  contactInfo  Json?
  trackingUrl  String?
  apiEndpoint  String?
  apiKey       String?
  isActive     Boolean  @default(true)
  countries    String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  shipments Shipment[]

  @@map("logistics_partners")
  @@schema("inventory_service")
}

// ──────────────────────────────────────────────
// Tax
// ──────────────────────────────────────────────

model TaxZone {
  id        String   @id @default(uuid())
  name      String
  countries String[]
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates TaxRate[]

  @@map("tax_zones")
  @@schema("inventory_service")
}

model TaxClass {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates TaxRate[]

  @@map("tax_classes")
  @@schema("inventory_service")
}

model TaxRate {
  id         String   @id @default(uuid())
  zoneId     String
  classId    String
  rate       Decimal  @db.Decimal(5, 2)
  name       String?
  priority   Int      @default(0)
  isCompound Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  zone     TaxZone  @relation(fields: [zoneId], references: [id])
  taxClass TaxClass @relation(fields: [classId], references: [id])

  @@map("tax_rates")
  @@schema("inventory_service")
}
