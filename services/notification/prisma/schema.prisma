// Notification Microservice Database Schema
//
// This schema defines the tables owned by the notification service.
// During Phase 1, this service shares the same PostgreSQL database as the
// monolith. The models here correspond EXACTLY to the monolith's tables so
// both can read/write safely. No new tables are created — we only reference
// the existing ones.
//
// As the migration progresses, this service will move to its own database.

generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/notification-client"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["notification_service"]
}

// ─── Notification (owned by this service) ─────────────────────────────────────

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  subject   String?
  content   String             @db.Text
  email     String?
  status    NotificationStatus @default(PENDING)
  sentAt    DateTime?
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime           @default(now())

  @@map("notifications")
  @@schema("notification_service")
}

enum NotificationType {
  ORDER_CONFIRMATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  RETURN_REQUESTED
  RETURN_APPROVED
  REVIEW_REMINDER
  WISHLIST_SALE

  @@schema("notification_service")
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  BOUNCED

  @@schema("notification_service")
}

// ─── WhatsApp (owned by this service) ─────────────────────────────────────────

model WhatsAppConversation {
  id            String             @id @default(uuid())
  phoneNumber   String
  userId        String?
  sellerId      String?
  ticketId      String?
  status        ConversationStatus @default(ACTIVE)
  lastMessageAt DateTime?
  messages      WhatsAppMessage[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([phoneNumber])
  @@index([userId])
  @@index([sellerId])
  @@index([ticketId])
  @@index([status])
  @@schema("notification_service")
}

model WhatsAppMessage {
  id             String               @id @default(uuid())
  conversationId String
  conversation   WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  messageId      String               @unique
  direction      MessageDirection
  content        String               @db.Text
  mediaUrl       String?
  status         MessageStatus        @default(SENT)
  deliveredAt    DateTime?
  readAt         DateTime?
  metadata       Json?
  createdAt      DateTime             @default(now())

  @@index([conversationId])
  @@index([messageId])
  @@index([direction])
  @@index([status])
  @@index([createdAt])
  @@schema("notification_service")
}

model WhatsAppTemplate {
  id         String   @id @default(uuid())
  name       String   @unique
  category   String
  content    String   @db.Text
  variables  String[]
  isActive   Boolean  @default(true)
  approvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@schema("notification_service")
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  BLOCKED

  @@schema("notification_service")
}

enum MessageDirection {
  INBOUND
  OUTBOUND

  @@schema("notification_service")
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED

  @@schema("notification_service")
}
