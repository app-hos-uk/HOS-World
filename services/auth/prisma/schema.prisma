// Auth Microservice Database Schema
//
// This schema defines the tables the auth service needs for login, registration,
// JWT token management, and OAuth. During the migration period, this service
// shares the same PostgreSQL database as the monolith.

generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/auth-client"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth_service", "public"]
}

// ─── User (core auth fields) ──────────────────────────────────────────────────

model User {
  id                           String    @id @default(uuid())
  email                        String    @unique
  password                     String?
  firstName                    String?
  lastName                     String?
  phone                        String?
  role                         UserRole  @default(CUSTOMER)
  avatar                       String?
  country                      String?
  whatsappNumber               String?
  preferredCommunicationMethod String?
  currencyPreference           String    @default("GBP")
  ipAddress                    String?
  gdprConsent                  Boolean   @default(false)
  gdprConsentDate              DateTime?
  dataProcessingConsent        Json?
  countryDetectedAt            DateTime?
  permissionRoleId             String?
  permissionRole               PermissionRole? @relation(fields: [permissionRoleId], references: [id])
  defaultTenantId              String?
  defaultTenant                Tenant?   @relation("DefaultTenant", fields: [defaultTenantId], references: [id], onDelete: SetNull)
  characterAvatarId            String?
  characterAvatar              Character? @relation("CharacterAvatar", fields: [characterAvatarId], references: [id])
  favoriteFandoms              String[]  @default([])
  gamificationPoints           Int       @default(0)
  level                        Int       @default(1)
  aiPreferences                Json?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt

  // Relations
  refreshTokens     RefreshToken[]
  oAuthAccounts     OAuthAccount[]
  gdprConsentLogs   GDPRConsentLog[]
  tenantMemberships TenantUser[]
  customerProfile   Customer?
  sellerProfile     Seller?
  userBadges        UserBadge[]

  // Customer Group
  customerGroupId String?

  @@map("users")
  @@schema("auth_service")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
  @@schema("auth_service")
}

model OAuthAccount {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider   String
  providerId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
  @@schema("auth_service")
}

model GDPRConsentLog {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  consentType String
  granted     Boolean
  grantedAt   DateTime?
  revokedAt   DateTime?
  ipAddress   String?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@map("gdpr_consent_logs")
  @@schema("auth_service")
}

// ─── Multi-Tenancy ────────────────────────────────────────────────────────────

model Tenant {
  id        String       @id @default(uuid())
  name      String
  subdomain String       @unique
  isActive  Boolean      @default(true)
  users     TenantUser[]
  defaultUsers User[]    @relation("DefaultTenant")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("tenants")
  @@schema("auth_service")
}

model TenantUser {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, userId])
  @@map("tenant_users")
  @@schema("auth_service")
}

// ─── RBAC ─────────────────────────────────────────────────────────────────────

model PermissionRole {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permission_roles")
  @@schema("auth_service")
}

// ─── Profile creation (write access during registration) ──────────────────────

model Customer {
  id                 String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  country            String?
  currencyPreference String   @default("GBP")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("customers")
  @@schema("auth_service")
}

model Seller {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeName       String
  slug            String   @unique
  country         String   @default("GB")
  timezone        String   @default("UTC")
  sellerType      String   @default("B2C_SELLER")
  logisticsOption String   @default("HOS_LOGISTICS")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("sellers")
  @@schema("auth_service")
}

model SellerInvitation {
  id         String   @id @default(uuid())
  email      String
  sellerType String
  token      String   @unique
  status     String   @default("PENDING")
  invitedBy  String
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("seller_invitations")
  @@schema("auth_service")
}

// ─── Gamification (read/write during registration) ────────────────────────────

model Character {
  id        String   @id @default(uuid())
  name      String   @unique
  fandomId  String?
  imageUrl  String?
  users     User[]   @relation("CharacterAvatar")
  createdAt DateTime @default(now())

  @@map("characters")
  @@schema("auth_service")
}

model Badge {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  imageUrl    String?
  userBadges  UserBadge[]
  createdAt   DateTime    @default(now())

  @@map("badges")
  @@schema("auth_service")
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, badgeId])
  @@map("user_badges")
  @@schema("auth_service")
}

enum UserRole {
  CUSTOMER
  WHOLESALER
  B2C_SELLER
  SELLER
  ADMIN
  INFLUENCER
  PROCUREMENT
  FULFILLMENT
  CATALOG
  MARKETING
  FINANCE
  CMS_EDITOR

  @@schema("auth_service")
}
