// Search Microservice Database Schema
//
// This schema defines the tables the search service needs read access to
// for indexing and fallback search. During the migration period, this service
// shares the same PostgreSQL database as the monolith.

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/search-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Product (read-only for indexing) ─────────────────────────────────────────

model Product {
  id               String           @id @default(uuid())
  name             String
  description      String?          @db.Text
  slug             String           @unique
  sku              String?
  barcode          String?
  price            Decimal          @default(0)
  currency         String           @default("GBP")
  stock            Int              @default(0)
  status           ProductStatus    @default(DRAFT)
  category         String?
  categoryId       String?
  fandom           String?
  sellerId         String
  seller           Seller           @relation(fields: [sellerId], references: [id])
  tags             String[]         @default([])
  averageRating    Float            @default(0)
  reviewCount      Int              @default(0)
  isPlatformOwned  Boolean          @default(false)
  images           ProductImage[]
  attributes       ProductAttribute[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId])
  @@map("product_images")
}

model ProductAttribute {
  id               String          @id @default(uuid())
  productId        String
  product          Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeId      String
  attribute        Attribute       @relation(fields: [attributeId], references: [id])
  attributeValueId String?
  attributeValue   AttributeValue? @relation(fields: [attributeValueId], references: [id])
  textValue        String?
  numberValue      Decimal?
  booleanValue     Boolean?
  createdAt        DateTime        @default(now())

  @@index([productId])
  @@index([attributeId])
  @@map("product_attributes")
}

model Attribute {
  id                String             @id @default(uuid())
  name              String
  slug              String             @unique
  type              AttributeType      @default(TEXT)
  values            AttributeValue[]
  productAttributes ProductAttribute[]
  createdAt         DateTime           @default(now())

  @@map("attributes")
}

model AttributeValue {
  id                String             @id @default(uuid())
  attributeId       String
  attribute         Attribute          @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  value             String
  slug              String
  productAttributes ProductAttribute[]
  createdAt         DateTime           @default(now())

  @@index([attributeId])
  @@map("attribute_values")
}

model Seller {
  id        String    @id @default(uuid())
  userId    String    @unique
  storeName String
  slug      String    @unique
  products  Product[]

  @@map("sellers")
}

enum ProductStatus {
  DRAFT
  PENDING
  ACTIVE
  INACTIVE
  ARCHIVED
  REJECTED
}

enum AttributeType {
  TEXT
  NUMBER
  BOOLEAN
  SELECT
  MULTI_SELECT
  COLOR
  DATE
}
