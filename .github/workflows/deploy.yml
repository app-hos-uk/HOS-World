name: Deploy

on:
  push:
    branches: [master]

jobs:
  deploy-api:
    name: Deploy API to Railway
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy API
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: api
        if: env.RAILWAY_TOKEN != ''
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-web:
    name: Deploy Web to Railway
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Web
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: web
        if: env.RAILWAY_TOKEN != ''
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  smoke-test:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-web]
    if: success()
    steps:
      - name: Wait for deployment propagation
        run: sleep 30
      - name: API health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://hos-marketplaceapi-production.up.railway.app/api/health || echo "000")
          echo "API health check status: $STATUS"
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "201" ]; then
            echo "::warning::API health check returned $STATUS"
          fi
      - name: Web health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://hos-marketplaceweb-production.up.railway.app/ || echo "000")
          echo "Web health check status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "::warning::Web health check returned $STATUS"
          fi
